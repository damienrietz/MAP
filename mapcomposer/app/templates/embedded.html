<!DOCTYPE html>
<html>
    <head>
        <!--meta http-equiv="X-UA-Compatible" content="IE=8" /-->
        <title>Map Viewer</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="shortcut icon" href="theme/app/img/favicon.ico">
		
        <!-- Ext resources -->
        <link rel="stylesheet" type="text/css" href="externals/ext/resources/css/ext-all.css">
        <link rel="stylesheet" type="text/css" href="externals/ext/resources/css/xtheme-gray.css">
        <script type="text/javascript" src="externals/ext/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="externals/ext/ext-all.js"></script>
        
		<!-- OpenLayers resources -->
        <link rel="stylesheet" type="text/css" href="externals/openlayers/theme/default/style.css">
        <script type="text/javascript" src="script/OpenLayers.js"></script>
		
		<!-- Externatls OpenLayers libraries to manage other extensions -->
		<script type="text/javascript" src="script/OpenLayersExt.js"></script> 
        
        <!-- Ask RingoJS for debug status -->
        <script type="text/javascript" src="debug.js"></script> 
		
		<link rel="stylesheet" type="text/css" href="theme/app/openlayers.css" />

        <!-- GeoExt resources -->
        <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/popup.css">
        <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/layerlegend.css">
        <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/gxtheme-gray.css">
        <script type="text/javascript" src="script/GeoExt.js"></script> 

		<!-- canvg-1.2 resources 
		<script type="text/javascript" src="script/canvg-1.2.js"></script> -->
		
        <!-- gxp resources -->
        <link rel="stylesheet" type="text/css" href="externals/gxp/src/theme/all.css">
        <script type="text/javascript" src="script/gxp.js"></script> 

        <!-- GeoExplorer resources  -->
        <link rel="stylesheet" type="text/css" href="theme/app/geoexplorer.css" />
        <link rel="stylesheet" type="text/css" href="theme/app/mapstore.css" />
        <!--[if IE]><link rel="stylesheet" type="text/css" href="theme/app/ie.css"/><![endif]-->        

        <script type="text/javascript" src="script/GeoExplorer.js"></script>
		
		<!-- UX libraries -->
        <script type="text/javascript" src="script/ux.js"></script>
        
        <!-- common data  -->
        <script type="text/javascript" src="config/common/localConfig.js"></script>

        <!-- translation data  -->
		<script type="text/javascript" src="translations/en.js"></script>
        <script type="text/javascript" src="translations/it.js"></script>
		
	    <!--script type="text/javascript" src="AddLayer.js"></script>
	    <script type="text/javascript" src="WMSSource.js"></script-->
		
		<!-- uncomment to have  welcome screen
        <script type="text/javascript">
		
			Ext.onReady(function() {
			  setTimeout(function(){
				Ext.get('loading').remove();
				Ext.get('loading-mask').fadeOut({remove:true});
			  }, 2000);
			});
		
		</script>
		
		<div id="loading-mask"></div>
		<div id="loading">
		  <div class="loading-indicator">
		  </div>
		</div>
		-->	
	
        <script>
            
            var app;
            var modified = false; var mapIdentifier = -1; var bbox; var fullScreen = false;
			
			// /////////////////////////////////////////////////////
			// Extra parameters to add layers at startup
			// /////////////////////////////////////////////////////
			var layName, layTitle, wmsurl, gsturl, urlformat, timeInterval;
		
			// ///////////////////////////////////////////////////////////////
            // Custom variables from the mapStoreConfig user configuration file 
            // ///////////////////////////////////////////////////////////////
            var proxy; 
            var serverConfig;
            var customConfigName;
            
			// //////////////////////////////////////////////////
            // Parsing the request to get the parameters
            // //////////////////////////////////////////////////
            var params = location.search.replace(/^\?/,'').replace(/&amp;/g,'&').split("&");
            for (var j=0; j < params.length; j++) {
				var param = params[j].split("=");
				if(param[0]){
					switch ( param[0] ) {
						case "mapId": 
									try {
										mapIdentifier = parseInt(param[1]);
									}catch(e){
										mapIdentifier = -1;
									} 
									break;
						case "bbox": 
									try{
										bbox = new OpenLayers.Bounds.fromString(param[1]);
									}catch(e){
										bbox = undefined;
									} 
									break;
						case "layName" : 
									layName = param[1]; 
									break;
						case "layTitle" : 
									layTitle = param[1]; 
									break;
						case "wmsurl" : 
									wmsurl = param[1]; 
									wmsurl = decodeURIComponent(wmsurl);
									break;
						case "gsturl" : 
									gsturl = param[1]; 
									gsturl = decodeURIComponent(gsturl);
									break;
                        case "config":
									customConfigName = param[1];
									break;
						case "format":
									urlformat = param[1];
									break;
						case "timeInterval":
									timeInterval = param[1];
									break;
						default : 
									//mapIdentifier = -1;
					}
				}
            }                      
			
            var onReady = function(){

                Ext.BLANK_IMAGE_URL = (function() {
                        if (Ext.isIE8 || Ext.isGecko || Ext.isOpera || Ext.isChrome) {
                            return "data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                        } else {
                            return "theme/app/img/blank.gif";
                        }
                })();

                OpenLayers.ImgPath = "externals/openlayers/theme/default/img/";
                
				// ////////////////////////////
                // Get Proj4js configuration 
				// ////////////////////////////
                if( typeof(Proj4js)!="undefined" && !(serverConfig.proj4jsDefs===undefined) ){
                    for(var name in serverConfig.proj4jsDefs){
                        Proj4js.defs[name] = serverConfig.proj4jsDefs[name];                    
                    }
                }
				
				// //////////////////////////////////////
                // Get georeferences data to override
				// //////////////////////////////////////
                if (serverConfig.georeferences_data){
                    georeferences_data = serverConfig.georeferences_data;
                }
				
                gxp.plugins.ZoomToExtent.prototype.closest = false;
            
				// //////////////////////////////////////////////////////            
				// Setting the locale based on query string parameter
				// //////////////////////////////////////////////////////
				var query = location.search;        
				if(query && query.substr(0,1) === "?"){
					query = query.substring(1);
				}
				
				var url = Ext.urlDecode(query);        
				var code = url.locale || serverConfig.defaultLanguage || "en";
				var langData = [['en', 'English']];				
							
				// ////////////////////////////////////////////////////
				// Setting the language code for the GeoExt tools
				// ////////////////////////////////////////////////////
				if (GeoExt.Lang) {
					GeoExt.Lang.set(code);
				}
				
                var appTabsOpts = {
					region: 'center',
					border : false,
					id : 'appTabs',
					enableTabScroll: true
				};
                    
                if(!serverConfig.tab){
                    appTabsOpts.layout = 'fit';
                    appTabs = new Ext.Panel(appTabsOpts); 
                }else{
                    appTabs = new Ext.TabPanel(appTabsOpts); 
                }
                
				var appViewport = new Ext.Viewport({
                    id: 'appVieport',
                    layout:'fit',
                    border:false,
                    items: [{
                        region : 'center',
                        layout : 'border',
                        border : false,
                        header : false,                    
                        items : [appTabs]
                    }]
                });
				
				if(gsturl){
					serverConfig.geoStoreBase = gsturl;
				}
                
                app = new GeoExplorer.Viewer({
				    defaultLanguage: serverConfig.defaultLanguage,	
					actionToolScale: serverConfig.actionToolScale || "small",
                    proxy: proxy,
					viewerTools: serverConfig.viewerTools,
					disableLayerChooser:serverConfig.disableLayerChooser,
                    defaultSourceType: "gxp_wmssource",
                    renderToTab : 'appTabs',
					portalConfig: serverConfig.portalConfig,
					loadingPanel: serverConfig.loadingPanel || {},
					geoStoreBaseURL: serverConfig.geoStoreBase || ('http://' + window.location.host + '/geostore/rest/'),	 
                    about: {
                        title: "Custom Map",
                        'abstract': "Custom Map",
                        contact: "<a href='#'>#</a>."
                    },
                    sources: serverConfig.gsSources || {
                        bing: {
                            ptype: "gxp_bingsource"
                        }
                    },
                    map: serverConfig.map,
					customTools: serverConfig.customTools
                }, mapIdentifier, false, fullScreen);   
                
                app.on({
                    'portalready' : function(){                    	

                    }, 
                    'ready' : function(){
                        app.modified = false;
						
						Ext.getCmp('paneltbar').hide();
						Ext.getCmp('panelbbar').hide();
						
						// ///////////////////////////////////////////////////
						// Visualizing metadata tab and layer at startup 
						// ///////////////////////////////////////////////////
						
						if(layName && wmsurl){
							var addLayer = app.tools["addlayer"];
							
							if(addLayer){						
                                
								var title = layTitle ? layTitle : layName;
								
								addMSLayer([{
									msLayerTitle: unescape(title),
									msLayerName: unescape(layName),
									msGroupName: undefined, // TODO: not supported yet
									wmsURL: wmsurl,
									format: urlformat,
									timeInterval: timeInterval
								}]);
							}else{
								Ext.Msg.show({
									title: "Add Layer",
									msg: "AddLayer plugin missing in configuration!",
									width: 300,
									icon: Ext.MessageBox.ALERT
								});  
							}
						}
						
						/*var resources = [{
							format: "wms",
							msGroupName: "MODELLO WRF-ARW a 12km - Maschera Terra - Acqua - (2015-04-21 ore 00 UTC).",
							msLayerName: "arw_12km_Geopotential_height_tropopause_20150425T000000000Z:0.0",
							msLayerTitle: "arw_12km_Geopotential_height_tropopause_20150425T000000000Z:0.0",
							wmsURL: "http://geoportale.lamma.rete.toscana.it/geoserver/ARW_12KM_RUN00/ows",
							timeInterval: "2015-04-25T00:00:00.000Z/2015-04-30T00:00:00.000Z"
						}];
                                
                        addMSLayer(resources);*/
						
						/*var resources = [{
							format: "wms",
							msGroupName: "MODELLO WRF-ARW a 12km - Maschera Terra - Acqua - (2015-04-21 ore 00 UTC).",
							msLayerName: "msg_rss_cvs",
							msLayerTitle: "msg_rss_cvs",
							wmsURL: "http://geoportale.lamma.rete.toscana.it/geoserver/MSG_RSS_RGB/ows"
						}];
                                
                        addMSLayer(resources);*/
						
						/*var resources = [{							
							format: "wms",
							msGroupName: "NDVI_2014 runs from 2014-01-01T00:00:00 UTC to 2014-12-19T00:00:00 UTC",
							msLayerName: "NDVI_2014",
							msLayerTitle: "NDVI_2014",
							wmsURL: "http://geoportale.lamma.rete.toscana.it/geoserver/NDVI/ows",
							timeInterval: "2014-01-01T00:00:00.000Z/2014-12-19T00:00:00.000Z"
						}];
								
						addMSLayer(resources);*/

						if(bbox){
							app.mapPanel.map.zoomToExtent(bbox);
						}
                    }
                });
				
			   /**
				* Add a WMS layer from GeoNetwork 
				*
				* TODO: Check the API using a MapServer URL as wmsURL.
				*/
				addMSLayer = function(resources){
					var addLayer = app.tools["addlayer"];
					var useCapabilities = true;
					
					for(var i=0; i<resources.length; i++){
						var resource = resources[i];
						var resourceName = resource.msLayerName;
						
						var customParams = {};
						
						//
						// Setting the Style
						//
						var layerString = resourceName.split(":");
						var styles, style, timeResolution;
						
						if((resourceName.indexOf("Wind") != -1) && (resourceName.indexOf("gfs") != -1)){
							styles = "wind_arrow_palette_gfs";
							style = "wind_arrow_palette_raster_gfs"; 
						}else if ((resourceName.indexOf("Wind") != -1) && (resourceName.indexOf("arw") != -1)){
							styles = "wind_arrow_palette";
							style = "wind_arrow_palette_raster";                         
						}else if(resource.wmsURL.indexOf('RADAR') != -1){					
							styles = layerString[0] + "_" + layerString[1];
							style = layerString[0] + "_" + layerString[1];                                                       
						}else{
							styles = layerString[0].substring(0,layerString[0].lastIndexOf("_")) + "_" + layerString[1];
							style = layerString[0].substring(0,layerString[0].lastIndexOf("_")) + "_" + layerString[1];
						}
						
						//
						// Setting the Group
						//
						if(resource.wmsURL.indexOf("ARW") != -1 || resource.wmsURL.indexOf("GFS") != -1){
							resource.msGroupName = "MODELLI";
							timeResolution = resourceName.indexOf("50km") != -1 ? "PT6H" : "PT1H";
							useCapabilities = false;							
						}else if(resource.wmsURL.indexOf("MSG") != -1){
							resource.msGroupName = "SATELLITE";
						}else if(resource.wmsURL.indexOf("NDVI") != -1){
							resource.msGroupName = "NDVI";
							//timeResolution = "P2W2D";
							//useCapabilities = false;
						}else if(resource.wmsURL.indexOf("RADAR") != -1){
							resource.msGroupName = "default";
						}else{
							resource.msGroupName = "default";
						}
						
						if(!useCapabilities){
							// Trim the WMS URL removing all parameters if any
							if(resource.wmsURL.indexOf("?") != -1){
								resource.wmsURL = resource.wmsURL.split("?")[0];
							}
						}
						
						//
						// Update the resource basic information
						//
						resource.msLayerName = layerString[0],
						resource.msLayerTitle = layerString[1] ? layerString[0] + ":" + layerString[1] : layerString[0],
						customParams.elevation = layerString[1] ? layerString[1] : "",
						customParams.styles = ((resourceName.indexOf("Wind") != -1) || layerString[1]) ? [styles] : [],
						customParams.style = ((resourceName.indexOf("Wind") != -1) || layerString[1]) ? [style] : [],
						customParams.format = "image/png8";					
						
						resource.customParams = customParams;
						
						if(!useCapabilities){
							if(resource.timeInterval){
								// Ensure an ISO Date format
								var timeIntervalArray = resource.timeInterval.split("/");
								for(var i=0; i<timeIntervalArray.length; i++){
									timeIntervalArray[i] = timeIntervalArray[i].indexOf("Z") == -1 ? 
										timeIntervalArray[i] + ".000Z" : timeIntervalArray[i];
								}														
								
								resource.customParams.dimensions = {
									time:{
										name: "time",
										units: "ISO8601",
										unitsymbol: null,
										nearestVal: false,
										multipleVal: false,
										current: false,
										default: "current",
										values: [timeIntervalArray.join("/") + "/" + timeResolution]
									}
								};
							}
						}
                        
						resource.sourceOptions = {
							useCapabilities: useCapabilities,
                            layerBaseParams: {
                                FORMAT: "image/png8",
                                TILED: true,
                                TILESORIGIN:"-20037508.34, -20037508.34"
                            }
                        };
					}				
						
					if(!useCapabilities){
						var playback = app.tools["playback"];
						
						addLayer.on({
							ready: function(records){		
								playback.on({
									rangemodified: function(){
										// Sets time parameter for added layers 
										app.addTemporalLayers(records);
									}
								});
							}
						});	
					}else{
						addLayer.on({
							ready: function(records){		
								// Sets time parameter for added layers 
								app.addTemporalLayers(records);
							}
						});
					}
					
					addLayer.addLayer(resources);
				};
            };			
                
			Ext.Ajax.request({
			      url: customConfigName ? "config/" + customConfigName + ".js"  : "config/preview.js",
				  method: 'GET',
				  success: function(response, opts){      
					    					  
					  try{
						  serverConfig = Ext.util.JSON.decode(response.responseText);
					  }catch(e){
						  Ext.Msg.show({
								title: "Startup",
							    msg: "An error occurred while parsing the external configuration: " + response.status,
								buttons: Ext.Msg.OK,
								icon: Ext.MessageBox.ERROR
						  });
					  }
					  
					  if(serverConfig){
                          //apply the local default configuration if not present.
						  serverConfig = Ext.applyIf(serverConfig,localConfig);
						  proxy = mapStoreDebug === true ? "/proxy/?url=" : serverConfig.proxy; 
						  
						  // ///////////////////////////////////////////////  
						  // Run the application when browser is ready
						  // ///////////////////////////////////////////////
						  Ext.onReady(onReady);
					  }
				  },
				  failure:  function(response, opts){
					  Ext.Msg.show({
							title: "Startup",
						    msg: "An error occurred while getting the external configuration: " + response.status,
							buttons: Ext.Msg.OK,
							icon: Ext.MessageBox.ERROR
					  });
				  }
			});
        
    </script>
    </head>
    <body>
        <% render content %>
		<div style="position:absolute; top:-10000px; left:-10000px; visibility:hidden"><canvas id="printcanvas" /></div>
    </body>
</html>
